<div class="h-full p-4 gap-4 overflow-hidden relative 2xl:grid 2xl:grid-cols-[400px_1fr_400px] text-text">
  <!-- Backdrop for mobile panel view -->
  @if ((isLeftSidebarOpen || isRightSidebarOpen) && isSmallScreen) {
    <div (click)="isLeftSidebarOpen = false; isRightSidebarOpen = false" class="fixed inset-0 bg-black/60 z-30 2xl:hidden" aria-hidden="true"></div>
  }

  <!-- Mobile Toggle Buttons -->
  @if (isSmallScreen) {
    <button (click)="toggleLeftSidebar()" class="2xl:hidden fixed top-1/2 -translate-y-1/2 left-4 z-40 rounded-full shadow-lg p-2 bg-primary text-text">
      <!-- Heroicon: user-circle -->
      <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>
  }
  @if (isSmallScreen) {
    <button (click)="toggleRightSidebar()" class="2xl:hidden fixed top-1/2 -translate-y-1/2 right-4 z-40 rounded-full shadow-lg p-2 bg-primary text-text">
      <!-- Heroicon: envelope -->
      <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
      </svg>
    </button>
  }

  <!-- Characters Panel (Left) -->
  <aside 
    class="bg-surface rounded-lg border-primary flex-col z-50 2xl:flex 2xl:w-[400px]"
    [ngClass]="{
      'hidden': isSmallScreen && !isLeftSidebarOpen,
      'flex fixed inset-0 portrait:w-5/6 landscape:w-1/2': isSmallScreen && isLeftSidebarOpen
    }">
    @if (isLeftSidebarOpen) {
      <button (click)="isLeftSidebarOpen = false" class="2xl:hidden absolute top-2 right-2 text-text-muted hover:text-primary">
        <!-- Heroicon: x-mark -->
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    }
    <div class="p-4 flex flex-col h-full">
      <h2 class="text-xl font-bold mb-4 flex-shrink-0">Characters</h2>
      <div class="overflow-y-auto flex-grow">
        @if (characters().length === 0) {<div class="text-text-muted">No characters yet.</div>}
        <div class="space-y-4">
          @for (char of characters(); track char.id) {
            <div class="bg-background shadow-md rounded-lg p-4 border border-primary">
              <h3 class="text-lg font-semibold mb-2 text-text">{{ char.name }}</h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label [for]="'health-' + char.id" class="block text-sm font-medium text-text-muted">Health</label>
                  <input type="number" [id]="'health-' + char.id" [(ngModel)]="char.health" (change)="onAttributeChange(char)" [disabled]="!canEdit(char)" class="mt-1 block w-full rounded-md bg-background border-primary text-text shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm disabled:opacity-50">
                </div>
                <div>
                  <label [for]="'mana-' + char.id" class="block text-sm font-medium text-text-muted">Mana</label>
                  <input type="number" [id]="'mana-' + char.id" [(ngModel)]="char.mana" (change)="onAttributeChange(char)" [disabled]="!canEdit(char)" class="mt-1 block w-full rounded-md bg-background border-primary text-text shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm disabled:opacity-50">
                </div>
                <div>
                  <label [for]="'strength-' + char.id" class="block text-sm font-medium text-text-muted">Strength</label>
                  <input type="number" [id]="'strength-' + char.id" [(ngModel)]="char.strength" (change)="onAttributeChange(char)" [disabled]="!canEdit(char)" class="mt-1 block w-full rounded-md bg-background border-primary text-text shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm disabled:opacity-50">
                </div>
                <div>
                  <label [for]="'agility-' + char.id" class="block text-sm font-medium text-text-muted">Agility</label>
                  <input type="number" [id]="'agility-' + char.id" [(ngModel)]="char.agility" (change)="onAttributeChange(char)" [disabled]="!canEdit(char)" class="mt-1 block w-full rounded-md bg-background border-primary text-text shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm disabled:opacity-50">
                </div>
                <div>
                  <label [for]="'intelligence-' + char.id" class="block text-sm font-medium text-text-muted">Intelligence</label>
                  <input type="number" [id]="'intelligence-' + char.id" [(ngModel)]="char.intelligence" (change)="onAttributeChange(char)" [disabled]="!canEdit(char)" class="mt-1 block w-full rounded-md bg-background border-primary text-text shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm disabled:opacity-50">
                </div>
              </div>
              <div class="text-xs text-text-muted mt-2">Owner: {{ char.ownerName }}</div>
            </div>
          }
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content Area (Whiteboard) -->
  <section class="z-0 flex items-center justify-center">
    <div class="relative w-[900px] h-[600px] bg-surface p-2 rounded-lg shadow-md flex flex-col items-center">
        
        <div class="flex items-center mb-4">
            <label for="colorPicker" class="mr-2 text-text">Color:
              <input id="colorPicker" type="color" [(ngModel)]="drawColor" class="w-8 h-8">
            </label>
            <label for="brushSize" class="ml-4 mr-2 text-text">Size:
              <input id="brushSize" type="range" min="1" max="20" [(ngModel)]="brushSize" class="w-32">
            </label>
        </div>
        <canvas #canvas class="bg-white rounded-md w-full h-full"></canvas>
    </div>
  </section>

  <!-- Chat Panel (Right) -->
  <aside 
    class="bg-surface rounded-lg border-primary flex-col z-50 2xl:flex 2xl:w-[400px]"
    [ngClass]="{
      'hidden': isSmallScreen && !isRightSidebarOpen,
      'flex fixed inset-0 portrait:w-5/6 landscape:w-1/2': isSmallScreen && isRightSidebarOpen
    }"
    [style.left]="isSmallScreen ? 'auto' : ''"
    [style.right]="isSmallScreen ? '0' : ''">
    <button (click)="isRightSidebarOpen = false" class="2xl:hidden absolute top-2 left-2 text-text-muted hover:text-primary">
      <!-- Heroicon: x-mark -->
      <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>
    <div class="p-4 flex flex-col h-full">
      <h2 class="text-xl font-bold mb-4 flex-shrink-0">Chat</h2>
      <div class="flex-grow bg-background rounded-lg p-4 flex flex-col">
        <div class="flex-grow overflow-y-auto mb-4 space-y-4">
          <div *ngFor="let message of messages" class="flex" [ngClass]="{
            'justify-end': message.senderId === currentUserId,
            'justify-start': message.senderId !== currentUserId
          }">
            <div class="rounded-lg p-3 max-w-xs" [ngClass]="{
              'bg-primary text-text': message.senderId === currentUserId,
              'bg-surface text-text': message.senderId !== currentUserId
            }">
              <div class="text-xs font-bold mb-1">{{ message.characterName }} - {{ message.senderName }}</div>
              <p class="text-sm">{{ message.text }}</p>
              <div class="text-xs text-text-muted mt-1 text-right">{{ message.timestamp | date:'shortTime' }}</div>
            </div>
          </div>
        </div>
        <div class="flex-shrink-0">
          <form (ngSubmit)="sendMessage()">
            <div class="flex">
              <input type="text" [(ngModel)]="newMessage" name="newMessage" class="flex-grow bg-background rounded-l-lg p-2 text-text focus:outline-none" placeholder="Type a message...">
              <button type="submit" class="bg-primary hover:bg-primary-dark text-text font-bold py-2 px-4 rounded-r-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </aside>
</div>